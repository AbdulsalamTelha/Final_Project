{% extends "base.html" %}

{% block title %} Chat:
    {% if room.type == 'private' %}
        {% for member in room.members.all %}
            {% if member != request.user %}
                {{ member.username.capitalize }}
            {% endif %}
        {% endfor %}
    {% else %}
        {{ room.name.upper }}
    {% endif %}
{% endblock title %}

{% block breadcrumb %}
{% endblock breadcrumb %}

{% block content %}
{% load custom_filters %}

<style>
  /*scroll ØªØ®ØµÙŠØµ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
  .custom-scrollbar::-webkit-scrollbar {
    width: 4px; /* Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø±ÙŠØ· */
  }

  .custom-scrollbar::-webkit-scrollbar-thumb {
    background-color: #cbd5e0; /* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ */
    border-radius: 4px; /* Ø§Ù„Ø­ÙˆØ§Ù Ø§Ù„Ù…Ø³ØªØ¯ÙŠØ±Ø© */
  }

  .custom-scrollbar::-webkit-scrollbar-track {
    background-color: transparent; /* Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø´ÙØ§ÙØ© */
  }

  .custom-scrollbar:hover::-webkit-scrollbar-thumb {
    background-color: #9ca3af; /* ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ† Ø¹Ù†Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ± */
  }
</style>
<div class="flex h-[80vh] w-[90vw] bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800 ">
    <!-- Sidebar -->
    <div class="w-1/4 bg-white dark:bg-gray-800 p-6 shadow-lg overflow-y-auto custom-scrollbar rounded-l-lg">

        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-semibold">Chats</h2>
        </div>

        

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØºØ±Ù -->
    <div id="rooms-container">
      <ul class="space-y-2"></ul>
    </div>

                        
        <!-- Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© -->
        <button id="user-list-button" class="fixed bottom-20 left-140 bg-background text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg z-50 hover:bg-blue-500 transition duration-300">
            <i class="fas fa-plus"></i>
        </button>

        <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
        <div id="user-list" class="fixed bottom-24 left-5 bg-white dark:bg-gray-800 rounded-lg shadow-lg w-64 max-h-80 overflow-y-auto hidden z-40">
            
            {% if request.user.role == 'INSTRUCTOR' or request.user.role == 'ADMIN' %}
                <button id="create-group-button" class="bg-[#1875BB] text-white px-4 py-2 rounded-lg hover:bg-[#1560A0] transition duration-300">
                    Create Group
                </button>
            {% endif %}

            <ul>
                {% for user in all_users %}
                {% if user != request.user %}
                    <li class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-300">
                        <a href="{% url 'start_private_chat' user.id %}" class="flex items-center text-gray-700 dark:text-gray-300">

                            <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center text-white font-bold">
                                {% if user.get_profile_image_url %}
                                    <img src="{{ user.get_profile_image_url }}" alt="{{ user.username }}" class="w-full h-full border-2 border-gray-500 rounded-full object-cover">
                                {% else %}
                                    <span class="text-black">{{ user.username|slice:":1"|upper }}</span>
                                {% endif %}
                            </div>

                            <div class="ml-3 flex-1">
                                <p class="text-sm font-medium text-gray-800 dark:text-gray-200">
                                    {{ user.username|capfirst }}
                                </p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">
                                    {{ user.get_role_display }}
                                </p>
                            </div>
                        </a>
                    </li>
                {% endif %}
                {% endfor %}
            </ul>
        </div>
    </div>
    <!-- Chat Area -->
    <div class="w-3/4 flex flex-col bg-white dark:bg-gray-900 shadow-lg rounded-r-lg">
        <!-- Chat Header -->

        <div class="p-4 bg-white dark:bg-gray-800 shadow-md flex items-center justify-between rounded-tr-lg">
            <!-- Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙŠØ³Ø±: Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© -->
            <div class="flex items-center flex-1 cursor-pointer" {% if room.type == 'group' %}onclick="showGroupMembers('{{ room.name }}')"{% endif %}>
                <!-- ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ© ØªØ¨Ø¯Ø£ Ø¨Ø£ÙˆÙ„ Ø­Ø±Ù -->
                <div class="flex-shrink-0 w-10 h-10 bg-gray-100 dark:bg-gray-200 rounded-full flex items-center justify-center text-white font-bold">
                    {% if room.type == 'private' %}
                        {% for user in all_users %}
                            {% for member in room.members.all %}
                                {% if member != request.user and member == user %}
                                    <img src="{{ user.get_profile_image_url }}" alt="{{ member }}" class="w-full h-full rounded-full object-cover border border-gray-100 dark:border-gray-200">
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                    {% else %}
                        <img src="/static/img/group.png" alt="room.name" class="w-full h-full rounded-full object-cover border border-gray-100 dark:border-gray-200">
                    {% endif %}
                </div>
                <!-- Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© -->
                <div class="ml-3">
                    <h1 class="{% if room.type == 'group' %}text-xl{% else %}text-2xl{% endif %} font-bold text-gray-800 dark:text-gray-200 ml-3">
                        {% if room.type == 'private' %}
                            {% for member in room.members.all %}
                                {% if member != request.user %}
                                    {{ member.username.capitalize }}
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            {{ room.name.upper }}
                        {% endif %}
                    </h1>
                    <!-- Ø¹Ø±Ø¶ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª) -->
                    {% if room.type == 'group' %}
                        <div class="text-sm text-gray-600 dark:text-gray-400">
                            Members: 
                            {% for member in room.members.all %}
                                {% if member != request.user %}
                                    {{ member.username }}{% if not forloop.last %}, {% endif %}
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        
            <!-- Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙŠÙ…Ù†: Ø²Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© -->
            {% if room.type == 'group' and room.created_by == request.user %}
                <div class="flex-shrink-0">
                    <a href="{% url 'manage_group' room.id %}" class="p-2 bg-gray-400 text-white rounded-lg hover:bg-blue-400 transition duration-300">
                        <i class="fas fa-cog"></i>  Manage Group
                    </a>
                </div>
            {% endif %}
        </div>

        <!-- Chat Messages -->
        <div id="chat-box" class="flex-1 p-4 overflow-y-auto custom-scrollbar ">
            {% comment %} {% for message in messages %}
            <div class="mb-4 flex {% if message.sender == request.user %}justify-end{% else %}justify-start{% endif %}">
                <div class="max-w-xs p-3 rounded-lg {% if message.sender == request.user %}bg-blue-500 text-white{% else %}bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200{% endif %} shadow-md">
                    <div class="text-sm font-medium mb-1">{{ message.sender.first_name }}</div>
                    {% if message.content_type == 'file' %}
                        <div class="mt-2 flex items-center">
                            <span class="mr-2">
                                <i class="{{ message.file_name|get_file_icon }}"></i>
                            </span>
                            <div>
                                <p class="text-sm font-medium text-gray-800 dark:text-gray-200">{{ message.file_name }}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">{{ message.file_size }} KB</p>
                            </div>
                            <a href="{{ message.content }}" download class="ml-2 p-1 bg-blue-500 text-white rounded-full hover:bg-blue-600">
                                <i class="fas fa-download"></i>
                            </a>
                        </div>
                    {% else %}
                        <div class="message-content">
                            {{ message.content|urlize }}
                        </div>
                    {% endif %}
                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ message.timestamp|time:"H:i" }}</div>
                </div>
            </div>
            {% endfor %} {% endcomment %}
        </div>

      <!-- Message Input -->
      <div class="p-4 bg-white dark:bg-gray-800 shadow-md">
        <div class="flex">
          <input
            type="text"
            id="chat-message-input"
            class="flex-1 p-2 border rounded-l-lg focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200"
            placeholder="Type a message..."
          />
          <input type="file" id="file-input" class="hidden" />
          <button
            id="file-upload-button"
            class="p-2 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 hover:bg-gray-400 dark:hover:bg-gray-500 transition duration-300"
          >
            ğŸ“
          </button>
          <button
            id="chat-message-submit"
            class="p-2 bg-blue-500 text-white rounded-r-lg hover:bg-blue-600 transition duration-300"
          >
            Send
          </button>
        </div>
        <!-- File Preview -->
        <div id="file-preview" class="mt-2 hidden">
          <div
            class="flex items-center p-2 bg-gray-100 dark:bg-gray-700 rounded-lg"
          >
            <div
              class="flex-shrink-0 w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold"
            >
              <i id="file-preview-icon" class="fas fa-file"></i>
            </div>
            <div class="ml-3 flex-1">
              <p
                id="file-name"
                class="text-sm font-medium text-gray-800 dark:text-gray-200"
              ></p>
              <p
                id="file-size"
                class="text-xs text-gray-500 dark:text-gray-400"
              ></p>
            </div>
            <button
              id="remove-file-button"
              class="p-1 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200"
            >
              âœ•
            </button>
          </div>
        </div>
        <div
          id="message-status"
          class="mt-2 text-sm text-gray-600 dark:text-gray-400"
        ></div>
      </div>
    </div>
  </div>

  <!-- Custom Modals -->
  <div
    id="error-modal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center"
  >
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
      <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200">Error</h2>
      <p id="error-message" class="mt-2 text-gray-600 dark:text-gray-400"></p>
      <button
        id="close-error-modal"
        class="mt-4 p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-300"
      >
        Close
      </button>
    </div>
  </div>

  <div
    id="internet-error-modal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center"
  >
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
      <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200">
        Connection Lost
      </h2>
      <p
        id="internet-error-message"
        class="mt-2 text-gray-600 dark:text-gray-400"
      >
        You are offline. Please check your internet connection.
      </p>
      <button
        id="close-internet-error-modal"
        class="mt-4 p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-300"
      >
        Close
      </button>
    </div>
  </div>

  <!-- Modal for creating a new group -->
  <div id="create-group-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg w-96">
        <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-200">Create New Group</h2>
        <form id="create-group-form" method="post" action="{% url 'create_group' %}">
            {% csrf_token %}
            
            <!-- Group Name -->
            <div class="mb-4">
                <label for="group-name" class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Group Name</label>
                <input type="text" name="name" id="group-name" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" />
                <span id="group-name-error" class="text-red-500 text-sm hidden"></span>
            </div>

            <!-- Group Type -->
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Group Type</label>
                <div class="flex space-x-4">
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="gender" value="male" class="form-radio" id="is-male-only" />
                        <span class="text-gray-700 dark:text-gray-300">Male Only</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="gender" value="female" class="form-radio" id="is-female-only" />
                        <span class="text-gray-700 dark:text-gray-300">Female Only</span>
                    </label>
                </div>
                <span id="gender-error" class="text-red-500 text-sm hidden"></span>
            </div>

            <!-- Search Students -->
            <div class="mb-4">
                <label for="search-student" class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Search Student</label>
                <input 
                    type="text" 
                    id="search-student" 
                    class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" 
                    placeholder="Search by name"
                >
            </div>

            <!-- Students List -->
            <div class="mb-4">
                <label for="student-ids" class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Select Students</label>
                <select name="student_ids" id="student-ids" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" multiple>
                    {% for student in all_users %}
                        {% if student != request.user and student.role == 'STUDENT' %}
                            <option 
                                value="{{ student.id }}" 
                                data-gender="{{ student.gender }}"
                            >
                                {{ student.username }}
                            </option>
                        {% endif %}
                    {% endfor %}
                </select>
                <span id="students-error" class="text-red-500 text-sm hidden"></span>
            </div>

            <!-- Buttons -->
            <div class="flex justify-end space-x-2">
                <button type="button" id="close-modal-button" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-300">Cancel</button>
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-300">Create</button>
            </div>
        </form>
    </div>
</div>

  <!-- Modal Ù„Ø¹Ø±Ø¶ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© -->
  <div
    id="group-members-modal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  >
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg w-96">
      <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">
        Group Members
      </h2>
      <ul id="group-members-list" class="space-y-2">
        <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ù‡Ù†Ø§ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… JavaScript -->
      </ul>
      <button
        id="close-group-members-modal"
        class="mt-4 p-2 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition duration-300"
      >
        Close
      </button>
    </div>
  </div>


  <script type="module">
            // Debugging: Log the room name and current user
            console.log("Room Name:", "{{ room.name }}");
            console.log("Current User ID:", "{{ request.user.id }}");

            // Import the functions you need from the SDKs you need
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
            import { getDatabase, ref, push, onChildAdded, onChildChanged, onChildRemoved,  query, limitToLast, onValue, update, remove } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-database.js";

            // Your web app's Firebase configuration
            const firebaseConfig = {
              apiKey: "AIzaSyBep8eDnc67uFHrpStN9swOgMdPKgWhbag",
              authDomain: "fir-s-s-chatapp.firebaseapp.com",
              databaseURL: "https://fir-s-s-chatapp-default-rtdb.firebaseio.com",
              projectId: "fir-s-s-chatapp",
              storageBucket: "fir-s-s-chatapp.firebasestorage.app",
              messagingSenderId: "679220975526",
              appId: "1:679220975526:web:5603c83b8735a7254ba167",
              measurementId: "G-Z4MBWVC3BP"
            };

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const database = getDatabase(app);

            const roomName = "{{ room.name }}";
            const currentUser = "{{ request.user.username }}";
            const chatBox = document.getElementById('chat-box');
            const messageInput = document.getElementById('chat-message-input');
            const submitButton = document.getElementById('chat-message-submit');
            const messageStatus = document.getElementById('message-status');
            const fileInput = document.getElementById('file-input');
            const fileUploadButton = document.getElementById('file-upload-button');
            const filePreview = document.getElementById('file-preview');
            const fileName = document.getElementById('file-name');
            const fileSize = document.getElementById('file-size');
            const filePreviewIcon = document.getElementById('file-preview-icon');
            const removeFileButton = document.getElementById('remove-file-button');

            // Debugging: Log Firebase initialization
            console.log("Firebase initialized with config:", firebaseConfig);

            // Function to get the file icon based on file type
            function getFileIcon(fileName) {
                if (!fileName) {
                    return 'fas fa-file'; // Default icon if fileName is undefined or null
                }
                const extension = fileName.split('.').pop().toLowerCase();
                switch (extension) {
                    case 'pdf':
                        return 'fas fa-file-pdf';
                    case 'jpg':
                    case 'jpeg':
                    case 'png':
                    case 'gif':
                        return 'fas fa-file-image';
                    case 'doc':
                    case 'docx':
                        return 'fas fa-file-word';
                    case 'xls':
                    case 'xlsx':
                        return 'fas fa-file-excel';
                    case 'zip':
                    case 'rar':
                        return 'fas fa-file-archive';
                    default:
                        return 'fas fa-file';
                }
            }

            // Function to show error modal
            function showErrorModal(message) {
              const errorModal = document.getElementById('error-modal');
              const errorMessage = document.getElementById('error-message');
              errorMessage.textContent = message;
              errorModal.classList.remove('hidden');
            }

            // Function to hide error modal
            function hideErrorModal() {
              const errorModal = document.getElementById('error-modal');
              errorModal.classList.add('hidden');
            }

            // Function to show internet error modal
            function showInternetErrorModal() {
              const internetErrorModal = document.getElementById('internet-error-modal');
              internetErrorModal.classList.remove('hidden');
            }

            // Function to hide internet error modal
            function hideInternetErrorModal() {
              const internetErrorModal = document.getElementById('internet-error-modal');
              internetErrorModal.classList.add('hidden');
            }

            // Close error modal when the close button is clicked
            document.getElementById('close-error-modal').addEventListener('click', hideErrorModal);
            document.getElementById('close-internet-error-modal').addEventListener('click', hideInternetErrorModal);

            // Check internet connectivity
            function checkInternetConnection() {
              if (!navigator.onLine) {
                showInternetErrorModal();
              }
            }

            // Listen for online/offline events
            window.addEventListener('online', () => {
              hideInternetErrorModal();
              console.log("Internet connection restored.");
            });

            window.addEventListener('offline', () => {
              showInternetErrorModal();
              console.log("Internet connection lost.");
            });

            // Initial internet connectivity check
            checkInternetConnection();

            // File upload button click handler
            fileUploadButton.addEventListener('click', () => fileInput.click());

            // File input change handler
            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    showFilePreview(file);
                }
            });

            // Function to show file preview
            function showFilePreview(file) {
                filePreview.classList.remove('hidden');
                fileName.textContent = file.name;
                fileSize.textContent = `${(file.size / 1024).toFixed(2)} KB`;
                filePreviewIcon.className = getFileIcon(file.name); // Set the file icon
            }

            // Remove file button click handler
            removeFileButton.addEventListener('click', () => {
                fileInput.value = ''; // Clear the file input
                filePreview.classList.add('hidden'); // Hide the preview
            });

            // Function to upload a file
            function uploadFile(file, message) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('message', message);  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ FormData

                fetch('/chat/upload_endpoint/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.url) {
                        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†ØµÙŠØ© Ù…Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù
                        push(ref(database, 'chat_rooms/' + roomName + '/messages'), {
                            sender: currentUser,
                            content: data.message ? `${data.message} - ${data.url}` : data.url,  // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø±Ø³Ù„ Ù…Ø¹ Ø§Ù„Ù…Ù„Ù
                            content_type: 'file',
                            file_name: file.name,
                            file_size: (file.size / 1024).toFixed(2),
                            timestamp: new Date().toISOString()
                        });
                    } else {
                        throw new Error('No URL returned from server');
                    }
                })
                .catch(error => {
                    console.error('Error uploading file:', error);
                    showErrorModal('Failed to upload file. Please try again.');
                })
                .finally(() => {
                    submitButton.disabled = false;
                    messageInput.disabled = false;
                    messageInput.value = '';
                    fileInput.value = '';
                    filePreview.classList.add('hidden');
                    messageStatus.textContent = "Sent";
                    messageStatus.style.color = "green";
                });
            }

            // Message submit button click handler
            submitButton.addEventListener('click', () => {
                const message = messageInput.value;
                const file = fileInput.files[0];

                if (message.trim() === "" && !file) {
                    showErrorModal("Message or file cannot be empty!");
                    return;
                }

                if (!navigator.onLine) {
                    showInternetErrorModal();
                    return;
                }

                submitButton.disabled = true;
                messageInput.disabled = true;
                messageStatus.textContent = "Sending...";
                messageStatus.style.color = "gray";

                const newMessageRef = push(ref(database, 'chat_rooms/' + roomName + '/messages'));
                const messageId = newMessageRef.key;

                const messageData = {
                    sender: currentUser,
                    content: message,
                    content_type: 'text',
                    timestamp: new Date().toISOString(),
                    status: 'sending'  // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                };

                if (file) {
                    uploadFile(file, message).then((fileUrl) => {
                        messageData.content = fileUrl;
                        messageData.content_type = 'file';
                        messageData.file_name = file.name;
                        messageData.file_size = (file.size / 1024).toFixed(2);
                        update(newMessageRef, messageData);
                    });
                } else {
                    update(newMessageRef, messageData);
                }

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
                onValue(newMessageRef, (snapshot) => {
                    const message = snapshot.val();
                    if (message && message.status === 'sending') {
                        update(newMessageRef, { status: 'sent' });
                    }
                });

                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
                submitButton.disabled = false;
                messageInput.disabled = false;
                messageInput.value = '';
                fileInput.value = '';
                filePreview.classList.add('hidden');
                messageStatus.textContent = "Sent";
                messageStatus.style.color = "green";
            });

            // Listen for new messages
            onChildAdded(ref(database, 'chat_rooms/' + roomName + '/messages'), (snapshot) => {
                const message = snapshot.val();
                const messageId = snapshot.key;
                const isOwnMessage = message.sender === currentUser;

                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø­Ø°ÙˆÙØ© Ù„Ù„Ø¬Ù…ÙŠØ¹
                if (message.isDeletedForEveryone) {
                    const messageElement = document.createElement('div');
                    messageElement.className = `mb-4 flex relative ${isOwnMessage ? 'justify-end' : 'justify-start'}`;
                    messageElement.dataset.messageId = messageId;
                    messageElement.innerHTML = `
                        <div class="max-w-xs p-3 rounded-lg ${isOwnMessage ? 'bg-blue-500 text-white' : 'bg-gray-200 dark:bg-gray-700'}">
                            <span class="text-gray-400 italic">This message has been deleted.</span>
                        </div>
                    `;
                    chatBox.appendChild(messageElement);
                    return;
                }

                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø­Ø°ÙˆÙØ© Ù…Ù† Ø¹Ù†Ø¯ÙŠ ÙÙ‚Ø·
                if (message.deletedFor?.[currentUser]) return;


                const messageElement = document.createElement('div');
                messageElement.className = `mb-4 flex relative ${isOwnMessage ? 'justify-end' : 'justify-start'}`;
                messageElement.dataset.messageId = messageId;

                const editedText = message.edited ? ' (edited)' : '';
                const messageContentText = message.content;

                let statusIcon = '';
                if (isOwnMessage) {
                    switch (message.status) {
                        case 'sending':
                            statusIcon = '<i class="fas fa-clock text-gray-400 ml-2"></i>';
                            break;
                        case 'sent':
                            statusIcon = '<i class="fas fa-check text-gray-400 ml-2"></i>';
                            break;
                        case 'delivered':
                            statusIcon = '<i class="fas fa-check-double text-gray-400 ml-2"></i>';
                            break;
                        case 'read':
                            statusIcon = '<i class="fas fa-check-double text-green-500 ml-2"></i>';
                            break;
                    }
                }

                const messageContent = `
                    <div class="max-w-xs p-3 rounded-lg ${isOwnMessage ? 'bg-blue-500 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200'} relative group">
                        <div class="text-sm font-medium mb-1">${message.sender.trim()}</div>
                        <div class="break-words whitespace-normal">
                            ${message.content_type === 'file' ? `
                                <div class="mt-2 flex items-center">
                                    <span class="mr-2">
                                        <i class="${getFileIcon(message.file_name)}"></i>
                                    </span>
                                    <div>
                                        <p class="text-sm font-medium text-gray-800 dark:text-gray-200">${message.file_name || 'Unnamed File'}</p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">${message.file_size || '0'} KB</p>
                                    </div>
                                    <a href="${message.content.trim()}" download class="ml-2 p-1 bg-blue-500 text-white rounded-full hover:bg-blue-600">
                                        <i class="fas fa-download"></i>
                                    </a>
                                </div>
                            ` : messageContentText}
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1 message-timestamp">
                            ${new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}${editedText}
                            <span class="status-icon">${getStatusIcon(message.status)}</span>
                        </div>
                        ${isOwnMessage ? `
                            <div class="absolute -top-2 -right-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                <button class="p-1 bg-gray-100 dark:bg-gray-600 rounded-full hover:bg-gray-200 dark:hover:bg-gray-500" onclick="showEditMessage('${messageId}')">
                                    <i class="fas fa-edit text-blue-500"></i>
                                </button>
                                <button class="p-1 bg-gray-100 dark:bg-gray-600 rounded-full hover:bg-gray-200 dark:hover:bg-gray-500 ml-1" onclick="confirmDeleteMessage('${messageId}')">
                                    <i class="fas fa-trash text-red-500"></i>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
                messageElement.innerHTML = messageContent;
                chatBox.appendChild(messageElement);
                chatBox.scrollTop = chatBox.scrollHeight;
            });



        function getStatusIcon(status) {
            switch (status) {
                case 'sending':
                    return '<i class="fas fa-clock text-gray-400 ml-2"></i>';
                case 'sent':
                    return '<i class="fas fa-check text-gray-400 ml-2"></i>';
                case 'delivered':
                    return '<i class="fas fa-check-double text-gray-400 ml-2"></i>';
                case 'read':
                    return '<i class="fas fa-check-double text-green-500 ml-2"></i>';
                default:
                    return '';
            }
        }


        onChildChanged(ref(database, 'chat_rooms/' + roomName + '/messages'), (snapshot) => {
            const updatedMessage = snapshot.val();
            const messageId = snapshot.key;
            const isOwnMessage = updatedMessage.sender === currentUser;

            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageElement) return;

            // Ø¥Ø°Ø§ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹
            if (updatedMessage.isDeletedForEveryone) {
                messageElement.innerHTML = `
                    <div class="max-w-xs p-3 rounded-lg ${isOwnMessage ? 'bg-blue-500 text-white' : 'bg-gray-200 dark:bg-gray-700'}">
                        <span class="text-gray-400 italic">This message has been deleted.</span>
                    </div>
                `;
                return;
            }

            // Ø¥Ø°Ø§ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø¹Ù†Ø¯ÙŠ ÙÙ‚Ø·
            if (updatedMessage.deletedFor?.[currentUser]) {
                messageElement.remove(); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                return;
            }

            // ØªØ­Ø¯ÙŠØ« Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØ­Ø§Ù„ØªÙ‡Ø§
            const contentDiv = messageElement.querySelector('.message-content') || messageElement.querySelector('.break-words');
            const timestampDiv = messageElement.querySelector('.message-timestamp');
            const statusIconDiv = messageElement.querySelector('.status-icon');

            if (contentDiv) {
                if (updatedMessage.isDeletedForEveryone) {
                    contentDiv.innerHTML = '<span class="text-gray-400 italic">This message has been deleted.</span>';
                } else if (updatedMessage.isDeletedForMe) {
                    messageElement.remove(); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø­Ø°ÙˆÙØ© Ù…Ù† Ø¹Ù†Ø¯ÙŠ ÙÙ‚Ø·
                    return;
                } else {
                    contentDiv.innerHTML = updatedMessage.content;
                }
            }

            if (timestampDiv) {
                const editedText = updatedMessage.edited ? ' (edited)' : '';
                timestampDiv.innerHTML = `
                    ${new Date(updatedMessage.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}${editedText}
                `;
            }

            if (statusIconDiv) {
                statusIconDiv.innerHTML = getStatusIcon(updatedMessage.status);
            }
        });



        onChildRemoved(ref(database, 'chat_rooms/' + roomName + '/messages'), (snapshot) => {
            const messageId = snapshot.key; // Get the unique ID of the removed message
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`); // Find the message element in the DOM

            if (messageElement) {
                messageElement.remove(); // Remove the message element from the DOM
            }
        });


            // Function to show edit message UI
            function showEditMessage(messageId) {
                const messageRef = ref(database, `chat_rooms/${roomName}/messages/${messageId}`);
                onValue(messageRef, (snapshot) => {
                    const message = snapshot.val();
                    if (!message || message.isDeleted) {
                        console.error("Message not found, already deleted, or cannot be edited.");
                        return;
                    }

                    if (message.content_type === 'file') return;

                    const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
                    if (!messageDiv) {
                        console.error("Message container not found");
                        return;
                    }

                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                    const contentDiv = messageDiv.querySelector('.message-content') || messageDiv.querySelector('.break-words');
                    if (!contentDiv) {
                        console.error("Message content div not found");
                        return;
                    }

                    // Ø­ÙØ¸ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„Ø±Ø³Ø§Ù„Ø©
                    const originalContent = message.content.trim(); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡ Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©

                    // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                    const editContainer = document.createElement('div');
                    editContainer.className = 'flex flex-col space-y-2';

                    const textarea = document.createElement('textarea'); // Ø§Ø³ØªØ®Ø¯Ø§Ù… textarea Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† input
                    textarea.value = originalContent; // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£ØµÙ„ÙŠ Ø¯ÙˆÙ† Ø¹Ù„Ø§Ù…Ø© (edited)
                    textarea.className = 'w-full p-2 border rounded-lg focus:outline-none bg-white text-black resize-none'; // Ø¥Ø¶Ø§ÙØ© resize-none Ù„Ù…Ù†Ø¹ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¬Ù…

                    const buttonContainer = document.createElement('div');
                    buttonContainer.className = 'flex space-x-2';

                    const saveButton = document.createElement('button');
                    saveButton.className = 'flex-1 p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600';
                    saveButton.textContent = 'Save';

                    const cancelButton = document.createElement('button');
                    cancelButton.className = 'flex-1 p-2 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500';
                    cancelButton.textContent = 'Cancel';

                    buttonContainer.appendChild(saveButton);
                    buttonContainer.appendChild(cancelButton);
                    editContainer.appendChild(textarea);
                    editContainer.appendChild(buttonContainer);

                    // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                    contentDiv.innerHTML = '';
                    contentDiv.appendChild(editContainer);

                    // Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
                    saveButton.addEventListener('click', () => {
                        const updatedContent = textarea.value.trim(); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡ Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©
                        update(messageRef, {
                            content: updatedContent,
                            edited: true,  // Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© "edited"
                            timestamp: new Date().toISOString()  // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª
                        })
                        .then(() => {
                            console.log("Message updated successfully");

                            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§
                            contentDiv.innerHTML = updatedContent;
                        })
                        .catch(error => {
                            console.error("Failed to update message:", error);
                            showErrorModal('Failed to update message. Please try again.');
                        });
                    });

                    // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                    cancelButton.addEventListener('click', () => {
                        contentDiv.innerHTML = originalContent; // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£ØµÙ„ÙŠ Ø¯ÙˆÙ† Ø¹Ù„Ø§Ù…Ø© (edited)
                    });
                });
            }

            // Function to confirm message deletion
            function confirmDeleteMessage(messageId) {
                const confirmModal = document.createElement('div');
                confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center';
                confirmModal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg w-96">
                        <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">Delete Message</h2>
                        <p class="mb-4 text-gray-600 dark:text-gray-400">Choose an option:</p>
                        <div class="flex flex-col space-y-2">
                            <button class="p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600" id="delete-for-me">Delete for me</button>
                            <button class="p-2 bg-red-500 text-white rounded-lg hover:bg-red-600" id="delete-for-everyone">Delete for everyone</button>
                            <button class="p-2 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500" id="cancel-delete">Cancel</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(confirmModal);

                // Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù†ÙŠ ÙÙ‚Ø·
                document.getElementById('delete-for-me').addEventListener('click', (event) => {
                    event.stopPropagation(); // Ù…Ù†Ø¹ Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„Ø­Ø¯Ø« Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø£ÙƒØ¨Ø±
                    const messageRef = ref(database, `chat_rooms/${roomName}/messages/${messageId}`);

                    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø·
                    update(messageRef, {
                        [`deletedFor/${currentUser}`]: true, // ØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
                        timestamp: new Date().toISOString()
                    }).then(() => {
                        console.log("Message deleted for me");
                        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                        if (messageElement) {
                            messageElement.remove(); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                        }
                    }).catch(error => {
                        console.error("Failed to delete message for me:", error);
                        showErrorModal('Failed to delete message. Please try again.');
                    });

                    confirmModal.remove(); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡
                });

                // Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø¬Ù…ÙŠØ¹
                // Ø­Ø°Ù Ù„Ù„Ø¬Ù…ÙŠØ¹
        document.getElementById('delete-for-everyone').addEventListener('click', (event) => {
            event.stopPropagation();
            const messageRef = ref(database, `chat_rooms/${roomName}/messages/${messageId}`);

            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            update(messageRef, {
                isDeletedForEveryone: true, // ØªÙ… Ø§Ù„Ø­Ø°Ù Ù„Ù„Ø¬Ù…ÙŠØ¹
                content: 'This message has been deleted.', // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ù†Øµ Ø§Ù„Ø­Ø°Ù
                timestamp: new Date().toISOString() // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª
            }).then(() => {
                console.log("Message deleted for everyone");
            }).catch(error => {
                console.error("Failed to delete message:", error);
            });

            confirmModal.remove();
        });

                document.getElementById('cancel-delete').addEventListener('click', (event) => {
                    event.stopPropagation(); // Ù…Ù†Ø¹ Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„Ø­Ø¯Ø« Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø£ÙƒØ¨Ø±
                    confirmModal.remove(); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
                });
            }

            // Attach functions to the window object to make them globally accessible
            window.showEditMessage = showEditMessage;
            window.confirmDeleteMessage = confirmDeleteMessage;

 




    // Function to fetch the last message for a room
    const chatRooms = {}; // ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºØ±Ù

    const allUsers = [
        {% for user in all_users %}
            {
                "username": "{{ user.username }}",
                "profile_image": "{{ user.get_profile_image_url }}"
            }
            {% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

            function fetchLastMessage(roomName, roomType, members, creationTime) {
                const messagesRef = ref(database, `chat_rooms/${roomName}/messages`);
                const lastMessageQuery = query(messagesRef, limitToLast(1));

                // Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆÙ‚Øª Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù† ØªØ§Ø±ÙŠØ®
                const creationDate = new Date(creationTime);
                if (isNaN(creationDate)) {
                    console.error("Invalid creation time:", creationTime);
                    return;
                }

                if (roomType === "group") {
                    chatRooms[roomName] = {
                        roomName: roomName,
                        roomType: roomType,
                        members: members,
                        lastMessage: "No messages yet",
                        lastMessageTime: creationDate, // ÙˆÙ‚Øª Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆÙ‚Øª Ø§ÙØªØ±Ø§Ø¶ÙŠ
                    };

                    sortAndRenderRooms(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                }

                onChildAdded(lastMessageQuery, (snapshot) => {
                    const message = snapshot.val();

                    if (message) {
                        const senderName = message.sender === "{{ request.user.username }}" ? "(You)" : message.sender;

                        chatRooms[roomName] = {
                            roomName: roomName,
                            roomType: roomType,
                            members: members,
                            lastMessage: `<strong>${senderName}:</strong> ${message.content}`,
                            lastMessageTime: new Date(message.timestamp),
                        };
                    } else if (roomType === "private") {
                        delete chatRooms[roomName]; // Ù„Ø§ ØªØ¶Ù Ø§Ù„ØºØ±Ù Ø§Ù„ÙØ±Ø¯ÙŠØ© Ø¨Ù„Ø§ Ø±Ø³Ø§Ø¦Ù„
                    }

                    sortAndRenderRooms();
                });
            }

        function sortAndRenderRooms() {
            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒØ§Ø¦Ù† Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© Ø«Ù… Ø§Ù„ÙØ±Ø²
            const sortedRooms = Object.values(chatRooms).sort((a, b) => {
                if (!a.lastMessageTime) return 1; // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØºØ±ÙØ© Ø¨Ù„Ø§ Ø±Ø³Ø§Ø¦Ù„ØŒ Ø¶Ø¹Ù‡Ø§ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„
                if (!b.lastMessageTime) return -1;
                return b.lastMessageTime - a.lastMessageTime; // ØªØ±ØªÙŠØ¨ ØªÙ†Ø§Ø²Ù„ÙŠ
            });

            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const roomsContainer = document.getElementById("rooms-container");
            roomsContainer.innerHTML = ""; // Ù…Ø³Ø­ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©

        sortedRooms.forEach((room) => {
            const roomElement = document.createElement("a");
            roomElement.href = `/chat/${room.roomName}`; // Ø±Ø§Ø¨Ø· Ø§Ù„ØºØ±ÙØ©
            roomElement.className =
                "flex items-center justify-between p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition duration-200";
            
            // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ© Ø£Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            let roomDisplayName = room.roomName.toUpperCase(); // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ©
            let profileImage = ""; // ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ø®Ø±

            if (room.roomType === 'private') {
                room.members.forEach(member => {
                    if (member !== "{{ request.user.username }}") {
                        roomDisplayName = member.charAt(0).toUpperCase() + member.slice(1); // Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø®Ø§ØµØ©

                        // ğŸ”¹ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ø®Ù„ allUsers
                        let userImage = "";
                        for (let i = 0; i < allUsers.length; i++) {
                            if (allUsers[i].username === member) {
                                userImage = allUsers[i].profile_image;
                                break;  // ØªÙˆÙ‚Ù Ø§Ù„Ø¨Ø­Ø« Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                            }
                        }

                        if (userImage) {
                            profileImage = `<img src="${userImage}" alt="${member}" class="w-full h-full rounded-full object-cover border border-gray-100 dark:border-gray-200">`;
                        }
                    }
                });
            } else {
                profileImage = `<img src="/static/img/group.png" alt="${room.roomName}" class="w-full h-full rounded-full object-cover border border-gray-200 dark:border-gray-200">`;
            }

            roomElement.innerHTML = `
                <div class="flex items-center flex-1 min-w-0">
                    <div class="flex-shrink-0 w-10 h-10 bg-gray-100 dark:bg-gray-200 rounded-full flex items-center justify-center text-white font-bold overflow-hidden">
                        ${profileImage || roomDisplayName.charAt(0).toUpperCase()}
                    </div>
                    <div class="ml-3 flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-800 dark:text-gray-200 truncate">
                            ${roomDisplayName}
                        </p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 truncate" id="last-message-${room.roomName}">
                            ${room.lastMessage}
                        </p>
                    </div>
                </div>
                <span class="text-xs text-gray-500 dark:text-gray-400 ml-2 flex-shrink-0 min-w-[50px] text-right" id="last-message-time-${room.roomName}">
                    ${
                        room.lastMessageTime
                            ? room.lastMessageTime.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
                            : ""
                    }
                </span>
            `;
            roomsContainer.appendChild(roomElement);
        });
    }

        // Ø¬Ù„Ø¨ Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© Ù„ÙƒÙ„ ØºØ±ÙØ©
        {% for room in request.user.chat_rooms.all %}
        fetchLastMessage(
            "{{ room.name }}",
            "{{ room.type }}",
            [{% for member in room.members.all %}"{{ member.username }}",{% endfor %}],
            "{{ room.creation_time|date:'c' }}"
        );
        {% endfor %}



        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }


        // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†

    const userListButton = document.getElementById('user-list-button');
    const userList = document.getElementById('user-list');

    userListButton.addEventListener('click', (event) => {
        event.stopPropagation(); // Ù…Ù†Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
        userList.style.display = userList.style.display === 'block' ? 'none' : 'block';
    });

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
    document.addEventListener('click', (event) => {
        if (event.target !== userListButton && !userList.contains(event.target)) {
            userList.style.display = 'none';
        }
    });





        // ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
const createGroupButton = document.getElementById('create-group-button');
const createGroupModal = document.getElementById('create-group-modal');
const closeModalButton = document.getElementById('close-modal-button');

createGroupButton.addEventListener('click', () => {
    createGroupModal.classList.remove('hidden');
});

closeModalButton.addEventListener('click', () => {
    createGroupModal.classList.add('hidden');
});

// Ø¥ØºÙ„Ø§Ù‚ Modal Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
window.addEventListener('click', (event) => {
    if (event.target === createGroupModal) {
        createGroupModal.classList.add('hidden');
    }
});

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
const createGroupForm = document.getElementById('create-group-form');
const groupNameInput = document.getElementById('group-name');
const groupNameError = document.getElementById('group-name-error');
const genderError = document.getElementById('gender-error');
const isMaleOnlyRadio = document.getElementById('is-male-only');
const isFemaleOnlyRadio = document.getElementById('is-female-only');
const studentsError = document.getElementById('students-error'); // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ù„Ø¹Ø±Ø¶ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨

createGroupForm.addEventListener('submit', async (event) => {
    event.preventDefault(); // Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ù†Ù…ÙˆØ°Ø¬

    const groupName = groupNameInput.value.trim();
    const isMaleOnly = isMaleOnlyRadio.checked;
    const isFemaleOnly = isFemaleOnlyRadio.checked;
    const studentIds = Array.from(studentSelect.selectedOptions).map(option => option.value);
    
    // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£
    groupNameError.classList.add('hidden');
    genderError.classList.add('hidden');
    studentsError.classList.add('hidden');

    let hasErrors = false;

    // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø³Ù…
    if (!groupName) {
        groupNameError.textContent = 'Please enter a group name.';
        groupNameError.classList.remove('hidden');
        hasErrors = true;
    } else if (groupName.length < 2 || groupName.length > 50) {
        groupNameError.textContent = 'Name must be between 3-50 characters.';
        groupNameError.classList.remove('hidden');
        hasErrors = true;
    } else if (!/^[A-Za-z0-9\s\-_]+$/.test(groupName)) {
        groupNameError.textContent = 'Only English letters, numbers, spaces, hyphens, and underscores are allowed.';
        groupNameError.classList.remove('hidden');
        hasErrors = true;
    }

    // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù†Ø³
    if (!isMaleOnly && !isFemaleOnly) {
        genderError.textContent = 'Please select a group type (Male Only or Female Only).';
        genderError.classList.remove('hidden');
        hasErrors = true;
    }

    // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø·Ù„Ø§Ø¨
    if (studentIds.length === 0) {
        studentsError.textContent = 'Please select at least one student.';
        studentsError.classList.remove('hidden');
        hasErrors = true;
    }

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£Ø®Ø·Ø§Ø¡ØŒ ØªÙˆÙ‚Ù Ø¹Ù† Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    if (hasErrors) {
        return;
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§
    const formData = new FormData(createGroupForm);
    

    formData.append('student_ids', studentIds.join(',')); // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†

    try {
        const response = await fetch("/chat/create_group/", { 
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}', // Ø¥Ø¶Ø§ÙØ© CSRF token
            },
        });

        const responseData = await response.json();
        console.log("Server Response:", responseData); // Ø·Ø¨Ø§Ø¹Ø© Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø®Ø§Ø¯Ù…

        if (response.ok) {
            // Ø¥Ø°Ø§ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­ØŒ ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
            window.location.href = `/chat/${responseData.room_name}/`;
        } else {
            // Ø¹Ø±Ø¶ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø®Ø§Ø¯Ù…
            if (responseData.errors) {
                for (const [field, message] of Object.entries(responseData.errors)) {
                    const errorElement = document.getElementById(`${field}-error`);
                    if (errorElement) {
                        errorElement.textContent = message;
                        errorElement.classList.remove('hidden');
                    } else {
                        alert(message); // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…Ø©
                    }
                }
            } else {
                alert(`Failed to create group: ${responseData.error}`);
            }
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while creating the group.');
    }
});

// ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ù„Ø§Ø¨
const searchStudentInput = document.getElementById('search-student');
const studentSelect = document.getElementById('student-ids');

searchStudentInput.addEventListener('input', () => {
    const searchQuery = searchStudentInput.value.toLowerCase();
    Array.from(studentSelect.options).forEach(option => {
        const studentName = option.text.toLowerCase();
        if (studentName.includes(searchQuery)) {
            option.style.display = 'block';
        } else {
            option.style.display = 'none';
        }
    });
});

// ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
isMaleOnlyRadio.addEventListener('change', updateStudentList);
isFemaleOnlyRadio.addEventListener('change', updateStudentList);

function updateStudentList() {
    const isMaleOnly = isMaleOnlyRadio.checked;
    const isFemaleOnly = isFemaleOnlyRadio.checked;
    Array.from(studentSelect.options).forEach(option => {
        const gender = option.getAttribute('data-gender');
        if ((isMaleOnly && gender === 'M') || (isFemaleOnly && gender === 'F')) {
            option.style.display = 'block';
        } else {
            option.style.display = 'none';
        }
    });
}

console.log("Form Data:", {
    name: groupNameInput.value.trim(),
    gender: isMaleOnlyRadio.checked ? 'male' : 'female',
    student_ids: Array.from(studentSelect.selectedOptions).map(option => option.value),
});






                // ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
    const groupMembersModal = document.getElementById('group-members-modal');
    const closeGroupMembersModal = document.getElementById('close-group-members-modal');
    const groupMembersList = document.getElementById('group-members-list');

    // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
// Ø¬Ø¹Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…ØªØ§Ø­Ø© ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…
window.showGroupMembers = function(roomName) {
    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
    fetch(`/chat/get_group_members/?room_name=${roomName}`)
        .then(response => response.json())
        .then(data => {
            if (data.members) {
                // Ù…Ø³Ø­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                groupMembersList.innerHTML = '';

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                data.members.forEach(member => {
                    // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
                    if (member.id === {{ request.user.id }}) return;

                    const memberItem = document.createElement('li');
                    memberItem.className = 'p-2 hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-300 cursor-pointer';
                    
                    // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø®Ø§ØµØ©
                    memberItem.innerHTML = `
                        <div class="flex items-center text-gray-700 dark:text-gray-300" onclick="startPrivateChat(${member.id})">
                            <div class="flex-shrink-0 w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white font-bold">
                                ${member.username.slice(0, 1).toUpperCase()}
                            </div>
                            <div class="ml-3 flex-1">
                                <p class="text-sm font-medium text-gray-800 dark:text-gray-200">${member.username}</p>
                            </div>
                        </div>
                    `;
                    groupMembersList.appendChild(memberItem);
                });

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·
                const currentUserItem = document.createElement('li');
                currentUserItem.className = 'p-2';
                currentUserItem.innerHTML = `
                    <div class="flex items-center text-gray-700 dark:text-gray-300">
                        <div class="flex-shrink-0 w-10 h-10 bg-gray-400 rounded-full flex items-center justify-center text-white font-bold">
                            {{ request.user.username|slice:":1"|upper }}
                        </div>
                        <div class="ml-3 flex-1">
                            <p class="text-sm font-medium text-gray-800 dark:text-gray-200">{{ request.user.username }}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">(You)</p>
                        </div>
                    </div>
                `;
                groupMembersList.appendChild(currentUserItem);

                // Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
                groupMembersModal.classList.remove('hidden');
            } else {
                alert('Failed to fetch group members.');
            }
        })
        .catch(error => {
            console.error('Error fetching group members:', error);
            alert('An error occurred while fetching group members.');
        });
};

// Ø¯Ø§Ù„Ø© Ù„Ø¨Ø¯Ø¡ Ø¯Ø±Ø¯Ø´Ø© Ø®Ø§ØµØ©
window.startPrivateChat = function(userId) {
    fetch(`/chat/start_private_chat/${userId}/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        },
    })
    .then(response => {
        if (response.ok) {
            window.location.href = response.url; // ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
        } else {
            alert('Failed to start private chat.');
        }
    })
    .catch(error => {
        console.error('Error starting private chat:', error);
        alert('An error occurred while starting private chat.');
    });
};

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
    closeGroupMembersModal.addEventListener('click', () => {
        groupMembersModal.classList.add('hidden');
    });

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
    window.addEventListener('click', (event) => {
        if (event.target === groupMembersModal) {
            groupMembersModal.classList.add('hidden');
        }
    });
    
  </script>
  {% endblock %}
</div>
