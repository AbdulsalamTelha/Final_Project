{% extends "base.html" %}
{% block content %}
<div class="flex h-screen bg-gray-100 dark:bg-gray-900">
    <!-- Sidebar -->
    <div class="w-1/4 bg-white dark:bg-gray-800 p-4 shadow-lg">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold text-gray-800 dark:text-gray-200">Chats</h2>
        </div>
        <ul>
            {% for room in request.user.chat_rooms.all %}
            <li class="mb-2">
                <a href="{% url 'chat_room' room.name %}" class="flex items-center p-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition duration-200">
                    <div class="flex-shrink-0 w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold">
                        {{ room.name|slice:":1"|upper }}
                    </div>
                    <div class="ml-3 flex-1">
                        <p class="text-sm font-medium text-gray-800 dark:text-gray-200">{{ room.name }}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Last message preview...</p>
                    </div>
                    <span class="text-xs text-gray-500 dark:text-gray-400">10:30 AM</span>
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Chat Area -->
    <div class="w-3/4 flex flex-col bg-gray-50 dark:bg-gray-900">
        <!-- Chat Header -->
        <div class="p-4 bg-white dark:bg-gray-800 shadow-lg">
            <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-200">{{ room.name }}</h1>
        </div>

        <!-- Chat Messages -->
        <div id="chat-box" class="flex-1 p-4 overflow-y-auto">
            {% for message in messages %}
            <div class="mb-4 flex {% if message.sender == request.user %}justify-end{% else %}justify-start{% endif %}">
                <div class="max-w-xs p-3 rounded-lg {% if message.sender == request.user %}bg-blue-500 text-white{% else %}bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200{% endif %}">
                    <strong>{{ message.sender.first_name }}:</strong> {{ message.content }}
                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ message.timestamp|time }}</div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Message Input -->
        <div class="p-4 bg-white dark:bg-gray-800 shadow-lg">
            <div class="flex">
                <input type="text" id="chat-message-input" class="flex-1 p-2 border rounded-l-lg focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200" placeholder="Type a message...">
                <button id="chat-message-submit" class="p-2 bg-blue-500 text-white rounded-r-lg">Send</button>
            </div>
            <!-- Message Status Indicator -->
            <div id="message-status" class="mt-2 text-sm text-gray-600 dark:text-gray-400"></div>
        </div>
    </div>
</div>

<!-- Custom Modal for Error Messages -->
<div id="error-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
        <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200">Error</h2>
        <p id="error-message" class="mt-2 text-gray-600 dark:text-gray-400"></p>
        <button id="close-error-modal" class="mt-4 p-2 bg-blue-500 text-white rounded-lg">Close</button>
    </div>
</div>

<!-- Custom Modal for Internet Connectivity Issues -->
<div id="internet-error-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
        <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200">Connection Lost</h2>
        <p id="internet-error-message" class="mt-2 text-gray-600 dark:text-gray-400">You are offline. Please check your internet connection.</p>
        <button id="close-internet-error-modal" class="mt-4 p-2 bg-blue-500 text-white rounded-lg">Close</button>
    </div>
</div>

<script type="module">
  // Debugging: Log the room name and current user
  console.log("Room Name:", "{{ room.name }}");
  console.log("Current User ID:", "{{ request.user.id }}");

  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-database.js";

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBep8eDnc67uFHrpStN9swOgMdPKgWhbag",
    authDomain: "fir-s-s-chatapp.firebaseapp.com",
    databaseURL: "https://fir-s-s-chatapp-default-rtdb.firebaseio.com",
    projectId: "fir-s-s-chatapp",
    storageBucket: "fir-s-s-chatapp.firebasestorage.app",
    messagingSenderId: "679220975526",
    appId: "1:679220975526:web:5603c83b8735a7254ba167",
    measurementId: "G-Z4MBWVC3BP"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);

  const roomName = "{{ room.name }}";
  const currentUser = "{{ request.user.id }}";
  const chatBox = document.getElementById('chat-box');
  const messageInput = document.getElementById('chat-message-input');
  const submitButton = document.getElementById('chat-message-submit');
  const messageStatus = document.getElementById('message-status');

  // Debugging: Log Firebase initialization
  console.log("Firebase initialized with config:", firebaseConfig);

  // Function to show error modal
  function showErrorModal(message) {
    const errorModal = document.getElementById('error-modal');
    const errorMessage = document.getElementById('error-message');
    errorMessage.textContent = message;
    errorModal.classList.remove('hidden');
  }

  // Function to hide error modal
  function hideErrorModal() {
    const errorModal = document.getElementById('error-modal');
    errorModal.classList.add('hidden');
  }

  // Function to show internet error modal
  function showInternetErrorModal() {
    const internetErrorModal = document.getElementById('internet-error-modal');
    internetErrorModal.classList.remove('hidden');
  }

  // Function to hide internet error modal
  function hideInternetErrorModal() {
    const internetErrorModal = document.getElementById('internet-error-modal');
    internetErrorModal.classList.add('hidden');
  }

  // Close error modal when the close button is clicked
  document.getElementById('close-error-modal').addEventListener('click', hideErrorModal);
  document.getElementById('close-internet-error-modal').addEventListener('click', hideInternetErrorModal);

  // Check internet connectivity
  function checkInternetConnection() {
    if (!navigator.onLine) {
      showInternetErrorModal();
    }
  }

  // Listen for online/offline events
  window.addEventListener('online', () => {
    hideInternetErrorModal();
    console.log("Internet connection restored.");
  });

  window.addEventListener('offline', () => {
    showInternetErrorModal();
    console.log("Internet connection lost.");
  });

  // Initial internet connectivity check
  checkInternetConnection();

  submitButton.addEventListener('click', () => {
      const message = messageInput.value;
      if (message.trim() === "") {
          showErrorModal("Message cannot be empty!");
          return;
      }

      // Check if the user is offline
      if (!navigator.onLine) {
          showInternetErrorModal();
          return;
      }

      // Disable the send button and input field while sending
      submitButton.disabled = true;
      messageInput.disabled = true;
      messageStatus.textContent = "Sending...";
      messageStatus.style.color = "gray";

      // Debugging: Log the message being sent
      console.log("Sending message:", message);

      push(ref(database, 'chat_rooms/' + roomName + '/messages'), {
          sender: currentUser,
          content: message,
          timestamp: new Date().toISOString()
      }).then(() => {
          console.log("Message sent successfully");
          messageStatus.textContent = "Sent";
          messageStatus.style.color = "green";
      }).catch((error) => {
          console.error("Error sending message:", error);
          showErrorModal("Failed to send message. Please check your internet connection.");
          messageStatus.textContent = "Failed to send";
          messageStatus.style.color = "red";
      }).finally(() => {
          // Re-enable the send button and input field
          submitButton.disabled = false;
          messageInput.disabled = false;
          messageInput.value = '';
      });
  });

  onChildAdded(ref(database, 'chat_rooms/' + roomName + '/messages'), (snapshot) => {
      const message = snapshot.val();
      // Debugging: Log the new message received
      console.log("New message received:", message);

      const messageElement = document.createElement('div');
      messageElement.className = `mb-4 flex ${message.sender === currentUser ? 'justify-end' : 'justify-start'}`;
      messageElement.innerHTML = `
          <div class="max-w-xs p-3 rounded-lg ${message.sender === currentUser ? 'bg-blue-500 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200'}">
              <strong>${message.sender}:</strong> ${message.content}
              <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">${new Date(message.timestamp).toLocaleTimeString()}</div>
          </div>
      `;
      chatBox.appendChild(messageElement);
      chatBox.scrollTop = chatBox.scrollHeight;
  }, (error) => {
      console.error("Error receiving messages:", error);
      showErrorModal("Failed to load messages. Please check your internet connection.");
  });

  // Dark Mode Toggle
  const darkModeToggle = document.getElementById('dark-mode-toggle');
  const htmlElement = document.documentElement;

  if (darkModeToggle) {
    darkModeToggle.addEventListener('click', () => {
        htmlElement.classList.toggle('dark');
        localStorage.setItem('darkMode', htmlElement.classList.contains('dark'));
        console.log("Dark Mode Toggled. New State:", htmlElement.classList.contains('dark'));
    });
  }

  // Check for saved dark mode preference
  if (localStorage.getItem('darkMode') === 'true') {
      htmlElement.classList.add('dark');
      console.log("Dark Mode Enabled on Page Load");
  } else {
      console.log("Dark Mode Disabled on Page Load");
  }
</script>
{% endblock %}