{% extends "base.html" %}
{% block content %}
<div class="flex h-screen bg-gray-100 dark:bg-gray-900">
    <!-- Sidebar -->
    <div class="w-1/4 bg-white dark:bg-gray-800 p-4 shadow-lg">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold text-gray-800 dark:text-gray-200">Chats</h2>
            <!-- Dark Mode Toggle -->
            {% comment %} <button id="dark-mode-toggle" class="p-2 bg-gray-200 dark:bg-gray-700 rounded-full">
                <span class="dark:hidden">üåô</span>
                <span class="hidden dark:inline">‚òÄÔ∏è</span>
            </button> {% endcomment %}
        </div>
        <ul>
            {% for room in request.user.chat_rooms.all %}
            <li class="mb-2">
                <a href="{% url 'chat_room' room.name %}" class="flex items-center p-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition duration-200">
                    <div class="flex-shrink-0 w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold">
                        {{ room.name|slice:":1"|upper }} <!-- Display the first letter of the chat room name -->
                    </div>
                    <div class="ml-3 flex-1">
                        <p class="text-sm font-medium text-gray-800 dark:text-gray-200">{{ room.name }}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Last message preview...</p> <!-- Placeholder for last message -->
                    </div>
                    <span class="text-xs text-gray-500 dark:text-gray-400">10:30 AM</span> <!-- Placeholder for last message time -->
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Chat Area -->
    <div class="w-3/4 flex flex-col bg-gray-50 dark:bg-gray-900">
        <!-- Chat Header -->
        <div class="p-4 bg-white dark:bg-gray-800 shadow-lg">
            <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-200">{{ room.name }}</h1>
        </div>

        <!-- Chat Messages -->
        <div id="chat-box" class="flex-1 p-4 overflow-y-auto">
            {% for message in messages %}
            <div class="mb-4 flex {% if message.sender == request.user %}justify-end{% else %}justify-start{% endif %}">
                <div class="max-w-xs p-3 rounded-lg {% if message.sender == request.user %}bg-blue-500 text-white{% else %}bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200{% endif %}">
                    <strong>{{ message.sender.first_name }}:</strong> {{ message.content }}
                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ message.timestamp|time }}</div> <!-- Message timestamp -->
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Message Input -->
        <div class="p-4 bg-white dark:bg-gray-800 shadow-lg">
            <div class="flex">
                <input type="text" id="chat-message-input" class="flex-1 p-2 border rounded-l-lg focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200" placeholder="Type a message...">
                <button id="chat-message-submit" class="p-2 bg-blue-500 text-white rounded-r-lg">Send</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-database.js";

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBep8eDnc67uFHrpStN9swOgMdPKgWhbag",
    authDomain: "fir-s-s-chatapp.firebaseapp.com",
    databaseURL: "https://fir-s-s-chatapp-default-rtdb.firebaseio.com",
    projectId: "fir-s-s-chatapp",
    storageBucket: "fir-s-s-chatapp.firebasestorage.app",
    messagingSenderId: "679220975526",
    appId: "1:679220975526:web:5603c83b8735a7254ba167",
    measurementId: "G-Z4MBWVC3BP"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);

  const roomName = "{{ room.name }}";
  const currentUser = "{{ request.user.id }}";
  const chatBox = document.getElementById('chat-box');
  const messageInput = document.getElementById('chat-message-input');
  const submitButton = document.getElementById('chat-message-submit');

  submitButton.addEventListener('click', () => {
      const message = messageInput.value;
      if (message.trim() === "") {
          alert("Message cannot be empty!");
          return;
      }

      push(ref(database, 'chat_rooms/' + roomName + '/messages'), {
          sender: currentUser,
          content: message,
          timestamp: new Date().toISOString()
      });

      messageInput.value = '';
  });

  onChildAdded(ref(database, 'chat_rooms/' + roomName + '/messages'), (snapshot) => {
      const message = snapshot.val();
      const messageElement = document.createElement('div');
      messageElement.className = `mb-4 flex ${message.sender === currentUser ? 'justify-end' : 'justify-start'}`;
      messageElement.innerHTML = `
          <div class="max-w-xs p-3 rounded-lg ${message.sender === currentUser ? 'bg-blue-500 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200'}">
              <strong>${message.sender}:</strong> ${message.content}
              <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">${new Date(message.timestamp).toLocaleTimeString()}</div>
          </div>
      `;
      chatBox.appendChild(messageElement);
      chatBox.scrollTop = chatBox.scrollHeight;
  });

  // Dark Mode Toggle
  const darkModeToggle = document.getElementById('dark-mode-toggle');
  const htmlElement = document.documentElement;

  darkModeToggle.addEventListener('click', () => {
      htmlElement.classList.toggle('dark');
      localStorage.setItem('darkMode', htmlElement.classList.contains('dark'));
  });

  // Check for saved dark mode preference
  if (localStorage.getItem('darkMode') === 'true') {
      htmlElement.classList.add('dark');
  }
</script>
{% endblock %}